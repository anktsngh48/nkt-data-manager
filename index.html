<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NKT Data Manager</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 10px;
  }

  input, select {
    width: 93%;
    padding: 10px;
    margin-bottom: 8px;
    font-size: 16px;
  }

  input[readonly] {
    background-color: #f5f5f5;
    color: #333;
  }

  .table-container {
    overflow-x: auto;
    border: 1px solid #ddd;
  }

  table {
    border-collapse: collapse;
    width: 100%;
  }

  td {
    border: 1px solid #ccc;
    padding: 8px;
    min-width: 80px;
    font-size: 14px;
  }

  td.selected {
    background-color: #e3f2fd;
  }
</style>
</head>

<body>

<input
  id="sheetDisplay"
  type="text"
  placeholder="Paste Google Sheet URL"
/>

<select id="tabs"></select>

<div class="table-container">
  <table id="grid"></table>
</div>

<script>
/* ================= CONFIG ================= */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxQm7rvFvSN8JoZhnxtipGnWEId3VhJxW35sN0qaGSMT0X8s-zkXO_1xInw1gRGBOwdtA/exec'; // must end with /exec
const STORAGE_KEY = 'nkt_sheet_data';

/* ================= ELEMENTS ================= */
const sheetDisplay = document.getElementById('sheetDisplay');
const tabs = document.getElementById('tabs');
const grid = document.getElementById('grid');

/* ================= STATE ================= */
let sheetId = '';
let sheetUrl = '';
let currentTab = '';
let selectedCell = null;

/* ================= HELPERS ================= */
function extractSheetId(url) {
  const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
  return match ? match[1] : '';
}

/* ================= LOAD SHEET NAME ================= */
async function loadSheetName() {
  const res = await fetch(
    `${SCRIPT_URL}?action=info&sheetId=${sheetId}`
  );
  const data = await res.json();
  return data.name;
}

/* ================= LOAD TABS ================= */
async function loadTabs() {
  const res = await fetch(
    `${SCRIPT_URL}?action=tabs&sheetId=${sheetId}`
  );
  const data = await res.json();

  tabs.innerHTML = '';
  data.sheets.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    tabs.appendChild(opt);
  });

  loadData();
}

/* ================= LOAD DATA ================= */
async function loadData() {
  currentTab = tabs.value;

  const res = await fetch(
    `${SCRIPT_URL}?action=data&sheetId=${sheetId}&tab=${currentTab}`
  );
  const data = await res.json();

  renderTable(data.values);
}

/* ================= RENDER TABLE ================= */
function renderTable(values) {
  grid.innerHTML = '';

  values.forEach((row, r) => {
    const tr = document.createElement('tr');

    row.forEach((cell, c) => {
      const td = document.createElement('td');
      td.textContent = cell ?? '';
      td.onclick = () => selectCell(td, r + 1, c + 1);
      tr.appendChild(td);
    });

    grid.appendChild(tr);
  });
}

/* ================= CELL EDIT ================= */
function selectCell(td, row, col) {
  if (selectedCell) selectedCell.classList.remove('selected');
  td.classList.add('selected');
  selectedCell = td;

  const newValue = prompt('Edit cell value', td.textContent);
  if (newValue !== null) updateCell(row, col, newValue);
}

async function updateCell(row, col, value) {
  await fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({
      sheetId,
      tab: currentTab,
      row,
      col,
      value
    })
  });

  selectedCell.textContent = value;
}

/* ================= INITIAL INPUT HANDLING ================= */
sheetDisplay.addEventListener('change', async () => {
  const input = sheetDisplay.value.trim();

  sheetId = extractSheetId(input);
  if (!sheetId) {
    alert('Invalid Google Sheet URL');
    return;
  }

  sheetUrl = input;
  const sheetName = await loadSheetName();

  localStorage.setItem(
    STORAGE_KEY,
    JSON.stringify({ sheetUrl, sheetName })
  );

  sheetDisplay.value = sheetName;
  sheetDisplay.readOnly = true;

  loadTabs();
});

/* ================= AUTO LOAD (PERMANENT) ================= */
window.addEventListener('load', async () => {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return;

  const data = JSON.parse(saved);
  sheetUrl = data.sheetUrl;
  sheetId = extractSheetId(sheetUrl);

  if (!sheetId) return;

  sheetDisplay.value = data.sheetName;
  sheetDisplay.readOnly = true;

  loadTabs();
});

tabs.addEventListener('change', loadData);
</script>

</body>
</html>
